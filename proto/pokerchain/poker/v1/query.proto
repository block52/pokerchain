syntax = "proto3";

package pokerchain.poker.v1;

import "amino/amino.proto";
import "cosmos/base/query/v1beta1/pagination.proto";
import "gogoproto/gogo.proto";
import "google/api/annotations.proto";
import "pokerchain/poker/v1/params.proto";
import "pokerchain/poker/v1/genesis.proto";

option go_package = "github.com/block52/pokerchain/x/poker/types";

// Query defines the gRPC querier service.
service Query {
  // Parameters queries the parameters of the module.
  rpc Params(QueryParamsRequest) returns (QueryParamsResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/params";
  }

  // Game Queries a list of Game items.
  rpc Game(QueryGameRequest) returns (QueryGameResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/game/{game_id}";
  }

  // ListGames Queries a list of ListGames items.
  rpc ListGames(QueryListGamesRequest) returns (QueryListGamesResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/list_games";
  }

  // PlayerGames Queries a list of PlayerGames items.
  rpc PlayerGames(QueryPlayerGamesRequest) returns (QueryPlayerGamesResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/player_games/{player_address}";
  }

  // LegalActions Queries a list of LegalActions items.
  rpc LegalActions(QueryLegalActionsRequest) returns (QueryLegalActionsResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/legal_actions/{game_id}/{player_address}";
  }

  // GameState Queries the detailed game state for a game (authenticated, shows your cards).
  rpc GameState(QueryGameStateRequest) returns (QueryGameStateResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/game_state/{game_id}";
  }

  // GameStatePublic Queries the public game state (unauthenticated, all cards masked).
  rpc GameStatePublic(QueryGameStatePublicRequest) returns (QueryGameStatePublicResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/game_state_public/{game_id}";
  }

  // IsTxProcessed checks if an Ethereum transaction hash has been processed
  rpc IsTxProcessed(QueryIsTxProcessedRequest) returns (QueryIsTxProcessedResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/is_tx_processed/{eth_tx_hash}";
  }

  // GetWithdrawalRequest queries a specific withdrawal request by nonce
  rpc GetWithdrawalRequest(QueryGetWithdrawalRequestRequest) returns (QueryGetWithdrawalRequestResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/withdrawal_request/{nonce}";
  }

  // ListWithdrawalRequests queries all withdrawal requests (optionally filtered by cosmos_address)
  rpc ListWithdrawalRequests(QueryListWithdrawalRequestsRequest) returns (QueryListWithdrawalRequestsResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/withdrawal_requests";
  }

  // CalculateEquity calculates hand equity using Monte Carlo simulation
  rpc CalculateEquity(QueryCalculateEquityRequest) returns (QueryCalculateEquityResponse) {
    option (google.api.http) = {
      post: "/block52/pokerchain/poker/v1/equity"
      body: "*"
    };
  }

  // Version returns chain version info and PVM health status
  rpc Version(QueryVersionRequest) returns (QueryVersionResponse) {
    option (google.api.http).get = "/block52/pokerchain/poker/v1/version";
  }
}

// QueryParamsRequest is request type for the Query/Params RPC method.
message QueryParamsRequest {}

// QueryParamsResponse is response type for the Query/Params RPC method.
message QueryParamsResponse {
  // params holds all the parameters of this module.
  Params params = 1 [
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// QueryGameRequest defines the QueryGameRequest message.
message QueryGameRequest {
  string game_id = 1;
}

// QueryGameResponse defines the QueryGameResponse message.
message QueryGameResponse {
  string game = 1;
}

// QueryListGamesRequest defines the QueryListGamesRequest message.
message QueryListGamesRequest {}

// QueryListGamesResponse defines the QueryListGamesResponse message.
message QueryListGamesResponse {
  string games = 1;
}

// QueryPlayerGamesRequest defines the QueryPlayerGamesRequest message.
message QueryPlayerGamesRequest {
  string player_address = 1;
}

// QueryPlayerGamesResponse defines the QueryPlayerGamesResponse message.
message QueryPlayerGamesResponse {
  string games = 1;
}

// QueryLegalActionsRequest defines the QueryLegalActionsRequest message.
message QueryLegalActionsRequest {
  string game_id = 1;
  string player_address = 2;
}

// QueryLegalActionsResponse defines the QueryLegalActionsResponse message.
message QueryLegalActionsResponse {
  string actions = 1;
}

// QueryGameStateRequest defines the QueryGameStateRequest message.
message QueryGameStateRequest {
  string game_id = 1;
  string player_address = 2;  // Cosmos address of the requesting player
  int64 timestamp = 3;         // Unix timestamp in seconds
  string signature = 4;        // Signature of the timestamp signed by the player's private key
}

// QueryGameStateResponse defines the QueryGameStateResponse message.
message QueryGameStateResponse {
  string game_state = 1;
}

// QueryGameStatePublicRequest defines the QueryGameStatePublicRequest message.
message QueryGameStatePublicRequest {
  string game_id = 1;
}

// QueryGameStatePublicResponse defines the QueryGameStatePublicResponse message.
message QueryGameStatePublicResponse {
  string game_state = 1;
}

// QueryIsTxProcessedRequest defines the request for checking if a tx has been processed
message QueryIsTxProcessedRequest {
  string eth_tx_hash = 1;
}

// QueryIsTxProcessedResponse defines the response for checking if a tx has been processed
message QueryIsTxProcessedResponse {
  bool processed = 1;
}

// QueryGetWithdrawalRequestRequest defines the request for getting a withdrawal request
message QueryGetWithdrawalRequestRequest {
  string nonce = 1;
}

// QueryGetWithdrawalRequestResponse defines the response for getting a withdrawal request
message QueryGetWithdrawalRequestResponse {
  WithdrawalRequest withdrawal_request = 1;
}

// QueryListWithdrawalRequestsRequest defines the request for listing withdrawal requests
message QueryListWithdrawalRequestsRequest {
  string cosmos_address = 1;  // Optional: filter by cosmos address (empty = all withdrawals)
  cosmos.base.query.v1beta1.PageRequest pagination = 2;
}

// QueryListWithdrawalRequestsResponse defines the response for listing withdrawal requests
message QueryListWithdrawalRequestsResponse {
  repeated WithdrawalRequest withdrawal_requests = 1;
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}

// QueryCalculateEquityRequest defines the request for calculating hand equity
message QueryCalculateEquityRequest {
  // hands: Array of hole cards for each player, e.g., [["AS", "KS"], ["QH", "QD"]]
  repeated HandCards hands = 1;
  // board: Community cards (0=preflop, 3=flop, 4=turn, 5=river)
  repeated string board = 2;
  // dead: Dead/mucked cards (optional)
  repeated string dead = 3;
  // simulations: Number of Monte Carlo simulations (default: 10000, max: 100000)
  int32 simulations = 4;
}

// HandCards represents hole cards for a single player
message HandCards {
  repeated string cards = 1;
}

// EquityResult represents the equity calculation result for a single hand
message EquityResult {
  int32 hand_index = 1;
  repeated string hand = 2;
  int32 wins = 3;
  int32 ties = 4;
  int32 losses = 5;
  string equity = 6;      // Win probability as decimal string (0-1)
  string tie_equity = 7;  // Equity from ties as decimal string
  string total = 8;       // Total equity (wins + tie share) as decimal string
}

// QueryCalculateEquityResponse defines the response for calculating hand equity
message QueryCalculateEquityResponse {
  repeated EquityResult results = 1;
  int32 simulations = 2;
  string stage = 3;         // "Preflop", "Flop", "Turn", "River"
  string duration_ms = 4;   // Duration in milliseconds
  string hands_per_sec = 5; // Hands evaluated per second
}

// QueryVersionRequest defines the request for getting version info
message QueryVersionRequest {}

// ChainVersion contains chain version information
message ChainVersion {
  string name = 1;
  string version = 2;
  uint64 consensus_version = 3;
}

// PvmStatus contains PVM health and version information
message PvmStatus {
  bool healthy = 1;
  string version = 2;
  string endpoint = 3;
  string error = 4;  // populated if unhealthy
}

// QueryVersionResponse defines the response for getting version info
message QueryVersionResponse {
  ChainVersion chain = 1;
  PvmStatus pvm = 2;
}
