# SDK: Automate Protobuf Type Generation and Integration

## Problem

When protobuf definitions (`.proto` files) are modified in the pokerchain, the SDK needs updated TypeScript types to properly encode transactions. Currently, this is a manual 3-step process that blocks frontend development.

**Current manual workflow:**
1. Developer modifies `.proto` files in pokerchain
2. Developer runs `ignite generate ts-client` in pokerchain directory
3. Developer copies generated types to SDK `/poker-vm/sdk/src/generated/`
4. Developer rebuilds SDK
5. Developer publishes SDK to npm

**Pain points:**
- Frontend developers get "Unregistered type url" errors when proto files are out of sync
- Manual copying is error-prone
- SDK can be published with stale types
- No clear ownership of who should run these steps

## ✅ RESOLVED (Oct 21, 2025)

**Status**: Implemented by Lucas Coullon in commit `fe0a6ac`

**What was done**:

1. Generated TypeScript client in pokerchain repo:
   ```bash
   cd /pokerchain
   ignite generate ts-client
   # Generated files in: /pokerchain/ts-client/pokerchain.poker.v1/
   ```

2. Copied ALL generated module folders to SDK src:
   ```bash
   cd /pokerchain
   cp -r ts-client/* ../poker-vm/sdk/src/
   # Copies: cosmos.auth.v1beta1, cosmos.bank.v1beta1, pokerchain.poker.v1, etc.
   ```

3. Added required dependencies to SDK package.json:
   ```json
   {
     "dependencies": {
       "@bufbuild/protobuf": "^2.10.0",
       "long": "^5.3.2"
     }
   }
   ```

4. Published SDK to npm as v3.0.1

**Result**:
- ✅ TypeScript types are now in `/poker-vm/sdk/src/pokerchain.poker.v1/`
- ✅ Dependencies installed automatically when UI imports SDK
- ✅ `createGame()` transactions work with correct type URL `/pokerchain.poker.v1.MsgCreateGame`
- ✅ Frontend can use SDK directly from npm without manual steps

**Note**: The `/poker-vm/sdk/src/generated/` folder exists but is empty/stale from Oct 17. The actual generated types are in module-specific folders like `pokerchain.poker.v1/`.

## Proposed Solution

### Option A: Automated Generation in Makefile (Recommended)

Add to `/pokerchain/Makefile`:

```makefile
proto-gen:
	@echo "Generating Go protobuf files..."
	ignite generate proto-go --yes
	@echo "Generating TypeScript client..."
	ignite generate ts-client
	@echo "Copying types to SDK..."
	cp -r ts-client/* ../poker-vm/sdk/src/
	@echo "Done! Remember to rebuild SDK: cd ../poker-vm/sdk && yarn build"

.PHONY: proto-gen
```

**Update**: This copies ALL generated modules (not just `pokerchain.poker.v1`) to maintain compatibility with Cosmos SDK types.

**When to run**: Every time someone modifies `.proto` files

**Benefits**:
- Single command updates both Go and TypeScript types
- Types stay in sync
- Clear workflow for developers

**Drawbacks**:
- SDK must be rebuilt manually after
- Requires monorepo structure

### Option B: Pre-Publish Hook in SDK

Add to `/poker-vm/sdk/package.json`:

```json
{
  "scripts": {
    "update-types": "cp -r ../../pokerchain/ts-client/* ./src/",
    "prepublishOnly": "yarn update-types && yarn build"
  }
}
```

**Update**: This copies ALL generated modules to maintain full Cosmos SDK type compatibility.

**Benefits**:
- Automatic type sync before npm publish
- Prevents publishing stale types

**Drawbacks**:
- Types can still be stale during local development
- Assumes pokerchain types are already generated

### Option C: CI/CD Automation

1. **GitHub Action** watches for changes to `.proto` files
2. Runs `ignite generate ts-client` in pokerchain
3. Copies types to SDK
4. Creates PR with updated types
5. Auto-increments SDK version
6. Publishes SDK to npm

**Benefits**:
- Fully automated
- No manual steps
- Types always in sync

**Drawbacks**:
- Requires CI/CD setup
- More complex initially

## Recommended Approach

**Short-term** (immediate fix):
1. Document the manual process in `/poker-vm/sdk/README.md`
2. Add warning in SDK package.json: `"⚠️ Run 'make proto-gen' in pokerchain after proto changes"`

**Long-term** (proper fix):
1. Implement **Option A** (Makefile integration) - covers 80% of use cases
2. Add **Option B** (prepublish hook) - safety net for npm publishing
3. Consider **Option C** (CI/CD) - if proto changes are frequent

## Action Items

1. [x] Decide on approach (A, B, C, or combination) - **Using Option A (manual for now)**
2. [x] Update `/pokerchain/Makefile` if using Option A - **Already has `make proto-gen`**
3. [ ] Update `/poker-vm/sdk/package.json` if using Option B - **Optional safety net**
4. [x] Document workflow in both repos:
   - `/pokerchain/CLAUDE.md` - **Updated with ts-client location**
   - `/poker-vm/sdk/README.md` - **Needs update**
5. [x] Commit generated types to SDK (or add to .gitignore if regenerating on-demand) - **Committed in fe0a6ac**
6. [x] Ensure dependencies are in SDK `package.json`: `long`, `@bufbuild/protobuf` - **Done in SDK package.json**

## Related Files

**Pokerchain**:
- `/pokerchain/proto/pokerchain/poker/v1/tx.proto` - Message definitions
- `/pokerchain/config.yml` - Ignite config (line 50-51: typescript path)
- `/pokerchain/Makefile` - Build targets
- `/pokerchain/ts-client/` - Generated TypeScript client (may or may not be committed)

**SDK**:
- `/poker-vm/sdk/src/signingClient.ts` - Uses generated registry
- `/poker-vm/sdk/src/pokerchain.poker.v1/` - Poker module generated types (actual location)
- `/poker-vm/sdk/src/cosmos.*.v*/` - Cosmos SDK module types
- `/poker-vm/sdk/src/generated/` - ⚠️ Empty/stale folder (ignore)
- `/poker-vm/sdk/package.json` - Dependencies (`@bufbuild/protobuf`, `long`)

**Frontend**:
- `/poker-vm/ui/src/pages/TestSigningPage.tsx` - Where errors surface
- `/poker-vm/ui/TOMS_CHECKLIST.md` - Frontend testing documentation

## Success Criteria

After implementing this solution:
- [x] Frontend developer can test poker transactions without manual type generation - **SDK v3.0.1 on npm**
- [x] SDK npm package includes up-to-date protobuf types - **Published with types**
- [x] Clear documentation exists for the workflow - **Documented in this file**
- [ ] Type mismatches are caught before publishing SDK - **Manual for now**
- [x] No "Unregistered type url" errors in production - **Fixed in v3.0.1**

## Test Case

**Before fix**:
```
Error: Unregistered type url: /block52.pokerchain.poker.MsgCreateGame
```

**After fix**:
```javascript
const txHash = await signingClient.createGame(...);
console.log("Success:", txHash); // DD36D7A537ABE6E2F80C653AB4BEF1DA4640229A2EFC41A124BAD0679B61EB2A
```

## Priority

**High** - This blocks frontend development whenever proto files change. Currently resolved with a local workaround, but needs proper automation to prevent future issues.

## Labels

`backend`, `sdk`, `build-system`, `protobuf`, `developer-experience`
